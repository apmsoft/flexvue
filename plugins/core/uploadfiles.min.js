define(["jquery","underscore","backbone","css!uploadfiles/jquery.uploadfile.css","jqueryform","uploadfiles/jquery.uploadfile.min","libs/js/function/image_manager.min"],function(e,a,i,o,l,t,n){var s={params:{showDownload:!1,previewWidth:"40px",previewHeight:"40px"},doc_id:"",target_id:"",initialize:function(e,i,o){var l=this;l.target_id=e,l.doc_id=i,a.extend(l.params,o)},run:function(){var i=this,o=[];console.log(app.docs[i.doc_id]);var l=app.docs[i.doc_id].uploadfiles_edit,t=l.value;a.isNull(app.server_language)||""==app.server_language||(t+=app.server_language);var n=i.target_id,s={url:t,formData:{upfilename:n,doc_id:i.doc_id,token:i.params.token},dragDrop:!0,fileName:n,maxFileCount:i.params.number_files_allowed,acceptFiles:i.params.default,returnType:"json",previewHeight:i.params.previewHeight,previewWidth:i.params.previewWidth,showDownload:i.params.showDownload,showFileCounter:!1,onLoad:function(o){DocAsyncTask.doGetContents(app.docs[i.doc_id].uploadfiles_load,{token:i.params.token,doc_id:i.doc_id,cache:!1},{success:function(i,l){a.each(l.msg,function(e){o.createProgress(e.hosturl,e.sfilename,e.ofilename,e.fullname.replace("/s/","/"),e.file_size,e.file_type,e.image_size)}),e(".ajax-file-upload-preview").unbind("click"),e(".ajax-file-upload-preview").on("click",function(a){a.preventDefault();var i=app.host_url+e(this).attr("src");i=i.replace("/m/","/");var o=window.open("about:blank");o.location.href=i})},fail:function(e){alert(e.msg)}})},onSuccess:function(i,l,t){if(void 0!==l.result&&"false"==l.result)return alert(l.msg),void e(target_id).focus();e(".ajax-file-upload-preview").unbind("click"),e(".ajax-file-upload-preview").on("click",function(){var i=e(this).data("filename");if(!a.contains(o,i)){var l=e(this).data("width"),t=e(this).data("height"),n=e(this).attr("src"),s=calculateAspectRatioFit(l,t,400,400),r='<div><a href="'+app.host_url+n+'" target="_blank"><img class="data-gallery lazy" data-filename="'+i+'" data-original="'+n+'" src='+n+' style="width:'+s.width+"px; height:"+s.height+'px;"></a></div>';e("#cke_description iframe").hasClass("cke_wysiwyg_frame")?e(".cke_wysiwyg_frame").contents().find("body").append(r):e("div").hasClass("note-editable")&&e(".note-editable").append(r),o.push(i)}}),console.log(l)},showDelete:!0,deleteCallback:!0,deleteCallback:function(e,a){for(var o=e.length,l=0;l<o;l++){e[l].ofilename,e[l].file_type,e[l].fullname;var t=e[l].sfilename;DocAsyncTask.doPostMessage(app.src+"/uploadfiles/delete",{token:i.params.token,doc_id:i.doc_id,op:"delete",name:t},{success:function(e){},fail:function(e){alert(e.msg)}})}},downloadCallback:function(e,a){var i=e[0].fullname;i=i.replace("/m/","/");var o=window.open("about:blank");o.location.href=app.host_url+i}};e(i.target_id).uploadFile(s)}};return s});