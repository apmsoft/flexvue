define(["jquery","underscore","backbone","backbone-fetch-cache"],function(e,l,t){var r=function(r,a){app.log(r);var i=r[0],n=r[1],p=i.frame,c=i.template,u="",s=t.Model.extend({urlRoot:"",initialize:function(e){app.log("request : initialize"),this.urlRoot=i.value,l.isNull(app.server_language)||""==app.server_language||(this.urlRoot+=app.server_language),l.isObject(i.value)||l.isNull(app.src)||""==app.src||l.isNull(i.value)||""==i.value||(this.urlRoot=app.src+"/"+this.urlRoot)},url:function(){var l=this.urlRoot+"?"+e.param(n);return app.log("url : "+l),l},getCacheKey:function(e){return l.isUndefined(n.cache_id),n.cache_id}}),o=t.View.extend({_cache_load:!1,initialize:function(){var e=this;if(l.bindAll(this,"render"),null==i.value)this.render(null,{result:"true",msg:""});else if(l.isObject(i.value))this.render(null,l.extend({result:"true",msg:""},i.value));else{var r=app.cache;!l.isUndefined(n.cache)&&app.cache&&(r=!!n.cache),this.model.fetch({prefill:r,prefillExpires:app.cache_time,prefillSuccess:function(){app.log("load cache_: "+e.model.getCacheKey({})),e._cache_load=!0;var l=t.fetchCache.getCache(e.model.getCacheKey({})).value;e.render(null,l)},success:function(l,t){e._cache_load||(app.log("fetch"),e.render(null,t))},error:this.error})}},render:function(t,r){var i=this;if(app.log("render------------"),app.log(JSON.stringify(r)),"false"!=r.result){if(l.isNull(p))i.render_template(r);else if(p.indexOf("#")>-1){var n=p.split("#"),c=n[0],u=n[1];require(["text!"+c+".html"],function(l){e("#"+u).html(l).promise().done(function(){i.render_template(r)})})}}else a(null,r)},render_template:function(t){if(l.isNull(c))a(null,t);else{if(c.indexOf("#")>-1){var r=c.split("#");c=r[0],u=r[1]}if("included"==c){var i=l.template(e("script#"+u).html());a(i(t),t)}else{for(var n=l.size(app.template),p=!1,s=0;s<n;s++)if(null!=app.template[s]&&app.template[s]==c){p=!0;break}if(p){i=l.template(e("script#"+u).html());a(i(t),t)}else require(["text!"+c+".html"],function(r){app.template[n]=c,e("body").append(r);var i=l.template(e("script#"+u).html());a(i(t),t)})}}},error:function(e,t){if(!l.isUndefined(t.responseText))try{a(null,JSON.parse(t.responseText))}catch(t){app.log(t)}}});new o({model:new s(i)})};return{initialize:r}});